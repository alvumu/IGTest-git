<ul class="list">
{%- assign dir          = include.dir          | default: '' -%}
{%- assign srcpath      = include.srcpath      | default: '' -%}
{%- assign nameContains = include.nameContains | default: '' -%}
{%- assign excludeIndex = include.excludeIndex | default: true -%}

{%- assign pages = site.pages -%}
{%- assign out = '' | split: '' -%}

{%- if dir != '' -%}
  {%- comment %} Normaliza dir a '/subcarpeta/' {% endcomment -%}
  {%- assign first = dir | slice: 0, 1 -%}
  {%- unless first == '/' -%}{%- assign dir = '/' | append: dir -%}{%- endunless -%}
  {%- assign last = dir | slice: -1, 1 -%}
  {%- unless last == '/' -%}{%- assign dir = dir | append: '/' -%}{%- endunless -%}
  {%- assign dlen = dir | size -%}
  {%- assign idxurl = dir | append: 'index.html' -%}

  {%- comment %} Quita site.baseurl de p.url antes de comparar {% endcomment -%}
  {%- assign sb = site.baseurl | default: '' -%}
  {%- for p in pages -%}
    {%- assign url_nb = p.url | default: '' -%}
    {%- if url_nb != '' and sb != '' and url_nb | slice: 0, sb.size == sb -%}
      {%- assign url_nb = url_nb | remove_first: sb -%}
    {%- endif -%}
    {%- if url_nb != '' -%}
      {%- assign prefix = url_nb | slice: 0, dlen -%}
      {%- if prefix == dir and url_nb != idxurl -%}
        {%- assign out = out | push: p -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}

{%- elsif srcpath != '' -%}
  {%- for p in pages -%}
    {%- if p.path and p.path contains srcpath -%}
      {%- assign out = out | push: p -%}
    {%- endif -%}
  {%- endfor -%}

{%- else -%}
  {%- assign out = pages -%}
{%- endif -%}

{%- if nameContains != '' -%}
  {%- assign needle = nameContains | downcase -%}
  {%- assign filtered = '' | split: '' -%}
  {%- for p in out -%}
    {%- assign fname = p.name | default: p.path | downcase -%}
    {%- if fname contains needle -%}
      {%- assign filtered = filtered | push: p -%}
    {%- endif -%}
  {%- endfor -%}
  {%- assign out = filtered -%}
{%- endif -%}

{%- if excludeIndex and dir != '' -%}
  {%- assign out = out | where_exp:'p','p.url != idxurl' -%}
{%- endif -%}

{%- comment %} No listarse a s√≠ misma {% endcomment -%}
{%- assign out = out | where_exp:'p','p.url != page.url' -%}

{%- assign out = out | uniq | sort: 'title' -%}

{%- for p in out -%}
  {%- assign title = p.title | default: p.name | default: p.url -%}
  {%- assign href = p.url | default: '' -%}
  {%- if href != '' and href | slice: 0, 1 != '/' -%}
    {%- assign href = '/' | append: href -%}
  {%- endif -%}
  {%- assign b = site.baseurl | default: '/IGTest-git' -%}
  <li><a href="{{ b | append: href }}">{{ title }}</a></li>
{%- endfor -%}

{%- if out == empty -%}
  <li><em>No entries found{% if dir != '' %} in {{ dir }}{% endif %}{% if srcpath != '' %} (srcpath={{ srcpath }}){% endif %}{% if nameContains != '' %} (name contains '{{ nameContains }}'){% endif %}</em></li>
{%- endif -%}
</ul>
