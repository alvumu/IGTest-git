<ul class="list">
{%- assign dir          = include.dir          | default: '' -%}
{%- assign srcpath      = include.srcpath      | default: '' -%}
{%- assign nameContains = include.nameContains | default: '' -%}
{%- assign excludeIndex = include.excludeIndex | default: true -%}

{%- assign pages = site.pages -%}
{%- assign out = '' | split: '' -%}

{%- if dir != '' -%}
  {%- assign first = dir | slice: 0, 1 -%}
  {%- unless first == '/' -%}{%- assign dir = '/' | append: dir -%}{%- endunless -%}
  {%- assign last = dir | slice: -1, 1 -%}
  {%- unless last == '/' -%}{%- assign dir = dir | append: '/' -%}{%- endunless -%}
  {%- assign dlen = dir | size -%}
  {%- assign idxurl = dir | append: 'index.html' -%}

  {%- for p in pages -%}
    {%- if p.url and p.url != '' -%}
      {%- assign prefix = p.url | slice: 0, dlen -%}
      {%- if prefix == dir and p.url != idxurl -%}
        {%- assign out = out | push: p -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}
{%- elsif srcpath != '' -%}
  {%- for p in pages -%}
    {%- if p.path and p.path contains srcpath -%}
      {%- assign out = out | push: p -%}
    {%- endif -%}
  {%- endfor -%}
{%- else -%}
  {%- assign out = pages -%}
{%- endif -%}

{%- if nameContains != '' -%}
  {%- assign needle = nameContains | downcase -%}
  {%- assign filtered = '' | split: '' -%}
  {%- for p in out -%}
    {%- assign fname = p.name | default: p.path | downcase -%}
    {%- if fname contains needle -%}
      {%- assign filtered = filtered | push: p -%}
    {%- endif -%}
  {%- endfor -%}
  {%- assign out = filtered -%}
{%- endif -%}

{%- if excludeIndex and dir != '' -%}
  {%- assign out = out | where_exp:'p','p.url != idxurl' -%}
{%- endif -%}

{%- assign out = out | uniq | sort: 'title' -%}

{%- for p in out -%}
  {%- assign title = p.title | default: p.name | default: p.url -%}
  {%- assign href = p.url | default: '' -%}

  {%- if dir != '' and href != '' -%}
    {# Estamos dentro de /<dir>/ → genera link relativo al directorio actual #}
    {%- assign href = href | remove_first: dir -%}
  {%- else -%}
    {# Sin dir: usa relative_url (aprovecha baseurl si está disponible) #}
    {%- assign href = href | relative_url -%}
  {%- endif -%}

  <li><a href="{{ href }}">{{ title }}</a></li>
{%- endfor -%}

{%- if out == empty -%}
  <li><em>No entries found{% if dir != '' %} in {{ dir }}{% endif %}{% if srcpath != '' %} (srcpath={{ srcpath }}){% endif %}{% if nameContains != '' %} (name contains '{{ nameContains }}'){% endif %}</em></li>
{%- endif -%}
</ul>
