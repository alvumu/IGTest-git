<ul class="list">
{%- assign dir          = include.dir          | default: '' -%}
{%- assign srcpath      = include.srcpath      | default: '' -%}
{%- assign nameContains = include.nameContains | default: '' -%}
{%- assign excludeIndex = include.excludeIndex | default: true -%}

{%- assign pages = site.pages -%}
{%- assign out = '' | split: '' -%}

{%- if dir != '' -%}
  {%- assign first = dir | slice: 0, 1 -%}
  {%- unless first == '/' -%}{%- assign dir = '/' | append: dir -%}{%- endunless -%}
  {%- assign last = dir | slice: -1, 1 -%}
  {%- unless last == '/' -%}{%- assign dir = dir | append: '/' -%}{%- endunless -%}
  {%- assign dlen = dir | size -%}
  {%- assign idxurl = dir | append: 'index.html' -%}

  {%- for p in pages -%}
    {%- if p.url and p.url != '' -%}
      {%- assign prefix = p.url | slice: 0, dlen -%}
      {%- if prefix == dir and p.url != idxurl -%}
        {%- assign out = out | push: p -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}
{%- elsif srcpath != '' -%}
  {%- for p in pages -%}
    {%- if p.path and p.path contains srcpath -%}
      {%- assign out = out | push: p -%}
    {%- endif -%}
  {%- endfor -%}
{%- else -%}
  {%- assign out = pages -%}
{%- endif -%}

{%- if nameContains != '' -%}
  {%- assign needle = nameContains | downcase -%}
  {%- assign filtered = '' | split: '' -%}
  {%- for p in out -%}
    {%- assign fname = p.name | default: p.path | downcase -%}
    {%- if fname contains needle -%}
      {%- assign filtered = filtered | push: p -%}
    {%- endif -%}
  {%- endfor -%}
  {%- assign out = filtered -%}
{%- endif -%}

{%- if excludeIndex and dir != '' -%}
  {%- assign out = out | where_exp:'p','p.url != idxurl' -%}
{%- endif -%}

{%- assign out = out | uniq | sort: 'title' -%}

{%- assign base = include.base | default: site.baseurl | default: '/IGTest-git' -%}
{%- comment -%} Normaliza base: empieza con '/', sin '/' final {%- endcomment -%}
{%- unless base -%}{%- assign base = '' -%}{%- endunless -%}
{%- assign bfirst = base | slice: 0, 1 -%}
{%- unless bfirst == '/' -%}{%- assign base = '/' | append: base -%}{%- endunless -%}
{%- assign base = base | replace: '//','/' -%}

{%- assign base_last = base | slice: -1, 1 -%}
{%- if base != '/' and base_last == '/' -%}
  {%- assign base_len = base | size -%}
  {%- assign base_len_minus1 = base_len | minus: 1 -%}
  {%- assign base = base | slice: 0, base_len_minus1 -%}
{%- endif -%}

{%- for p in out -%}
  {%- assign title = p.title | default: p.name | default: p.url -%}
  {%- assign href = p.url | default: '' -%}

  {%- if dir != '' and href != '' -%}
    {# normaliza dir a '/subcarpeta/' #}
    {%- assign first = dir | slice: 0, 1 -%}
    {%- unless first == '/' -%}{%- assign dir = '/' | append: dir -%}{%- endunless -%}
    {%- assign last = dir | slice: -1, 1 -%}
    {%- unless last == '/' -%}{%- assign dir = dir | append: '/' -%}{%- endunless -%}

    {%- assign fname = href | remove_first: dir -%}      {# 'AgeAt…html' #}
    {%- assign path  = dir | append: fname -%}           {# '/profiles/AgeAt…html' #}
    {%- assign final = base | append: path -%}           {# '/IGTest-git/profiles/AgeAt…html' #}
  {%- else -%}
    {%- comment -%} Sin dir: también fuerza base para coherencia {%- endcomment -%}
    {%- assign final = base | append: href -%}
  {%- endif -%}

  <li><a href="{{ final }}">{{ title }}</a></li>
{%- endfor -%}


{%- if out == empty -%}
  <li><em>No entries found{% if dir != '' %} in {{ dir }}{% endif %}{% if srcpath != '' %} (srcpath={{ srcpath }}){% endif %}{% if nameContains != '' %} (name contains '{{ nameContains }}'){% endif %}</em></li>
{%- endif -%}
</ul>
